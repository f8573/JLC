plugins {
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
    id 'java'
    id 'application'
}

group = 'net.faulj'
version = '1.0-SNAPSHOT'

ext['tomcat.version'] = '10.1.14'

repositories {
    mavenCentral()
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

//
// ===== Enable Panama Vector API =====
//

tasks.withType(JavaCompile).configureEach {
    options.fork = true
    options.compilerArgs += [
            '--add-modules=jdk.incubator.vector',
            '--enable-preview'
    ]
}

tasks.withType(Test).configureEach {
    jvmArgs += [
            '--add-modules=jdk.incubator.vector',
            '--enable-preview'
    ]
}

tasks.withType(JavaExec).configureEach {
    jvmArgs += [
            '--add-modules=jdk.incubator.vector',
            '--enable-preview'
    ]
}


//
// ===== OS / Arch helpers =====
//

def static getOsString() {
    String vendor = System.getProperty("java.vendor")
    if ("The Android Project" == vendor) return "android"

    String osName = System.getProperty("os.name").toLowerCase(Locale.ENGLISH)

    if (osName.startsWith("windows")) return "windows"
    if (osName.startsWith("mac os")) return "apple"
    if (osName.startsWith("linux")) return "linux"
    if (osName.startsWith("sun")) return "sun"

    return "unknown"
}

def static getArchString() {
    String osArch = System.getProperty("os.arch").toLowerCase(Locale.ENGLISH)

    if (osArch in ["i386", "x86", "i686"]) return "x86"
    if (osArch.startsWith("amd64") || osArch.startsWith("x86_64")) return "x86_64"
    if (osArch.startsWith("arm64")) return "arm64"
    if (osArch.startsWith("arm")) return "arm"

    return "unknown"
}

//
// ===== Dependencies =====
//

dependencies {

    // Testing
    testImplementation 'junit:junit:4.13.2'

    // Spring Boot web
    implementation 'org.springframework.boot:spring-boot-starter-web'

    // ===== JCuda =====

    def jCudaVersion = "11.0.0"
    def classifier = getOsString() + "-" + getArchString()

    implementation("org.jcuda:jcuda:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcublas:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcufft:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcusparse:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcurand:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcusolver:$jCudaVersion") { transitive = false }
    implementation("org.jcuda:jcudnn:$jCudaVersion") { transitive = false }

    implementation "org.jcuda:jcuda-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcublas-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcufft-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcusparse-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcurand-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcusolver-natives:$jCudaVersion:$classifier"
    implementation "org.jcuda:jcudnn-natives:$jCudaVersion:$classifier"
}

//
// ===== Application Entrypoints =====
//

application {
    mainClass = 'net.faulj.visualizer.RunVisualizer'
}

bootRun {
    mainClass = 'net.faulj.web.Application'
    // Keep full tiered JIT for numeric benchmark fidelity; Boot's optimizedLaunch
    // sets TieredStopAtLevel=1, which severely under-reports FLOPS.
    optimizedLaunch = false
}

//
// ===== Test config =====
//

test {
    systemProperty 'faulj.cuda.enabled', 'true'
    testLogging {
        showStandardStreams = true
    }
}

// Run test main benchmark class from test sources
tasks.register('runDiagnostic', JavaExec) {
    group = 'benchmark'
    description = 'Run net.faulj.benchmark.Diagnostic512 from test classes'
    classpath = sourceSets.test.runtimeClasspath
    // Use Java 21 for Spring Boot 3.1.x / Spring 6.0.x compatibility.
    javaLauncher = javaToolchains.launcherFor {
        languageVersion = JavaLanguageVersion.of(21)
    }
    main = 'net.faulj.benchmark.Diagnostic512'
    standardInput = System.in
}
